{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}

<style>
    .reserva-wrapper {
        max-width: 900px;
        margin: 40px auto;
        background: rgba(255,255,255,0.95);
        padding: 30px;
        border-radius: 18px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .reserva-wrapper input,
    .reserva-wrapper select,
    .reserva-wrapper textarea {
        border-radius: 10px !important;
        padding: 10px !important;
        border: 1px solid #ccc !important;
    }
    .resumen-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-top: 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.10);
    }
    .reserva-btn {
        background: linear-gradient(90deg, #4FB96F, #2E8F4A);
        border: none;
        color: white;
        padding: 14px;
        width: 100%;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        transition: 0.25s;
    }
    .reserva-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }
</style>


<div class="reserva-wrapper">

    <h1 class="mb-3">Reservar evento</h1>

    <h4 class="mb-3">Productos en tu canasta</h4>

    {% if productos %}
        <ul>
            {% for p in productos %}
                <li>{{ p.name }} â€” <strong>${{ p.price|intcomma }}</strong></li>
            {% endfor %}
        </ul>
        <p><strong>Total productos:</strong> ${{ total_productos|intcomma }}</p>
    {% else %}
        <p>No has agregado productos todavÃ­a.</p>
    {% endif %}

    <hr>
    <p><strong>Precio por hora del servicio:</strong> $20.000 CLP</p>
    <hr>

    {% if messages %}
        {% for m in messages %}
            <div class="alert alert-info">{{ m }}</div>
        {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <!-- FORMULARIO -->
    <form method="post" id="reserva-form">
        {% csrf_token %}

        <label class="mt-2">Nombre completo:</label>
        <input type="text" name="customer_name" class="form-control"
               value="{{ form.customer_name.value|default:'' }}" required>

        <label class="mt-3">Correo electrÃ³nico:</label>
        <input type="email" name="customer_email" class="form-control"
               value="{{ form.customer_email.value|default:'' }}" required>

        <label class="mt-3">TelÃ©fono de contacto:</label>
        <input type="text" name="customer_phone" class="form-control"
               value="{{ form.customer_phone.value|default:'' }}" required>

        <label class="mt-3">Fecha del evento:</label>
        <input type="date" name="event_date" class="form-control"
               value="{{ form.event_date.value|default:'' }}" required>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>Hora inicio:</label>
                {{ form.start_time }}
            </div>

            <div class="col-md-6">
                <label>Hora tÃ©rmino:</label>
                {{ form.end_time }}
            </div>
        </div>

        <label class="mt-3">Lugar del evento:</label>
        <input type="text" name="location" class="form-control"
               value="{{ form.location.value|default:'' }}" required>

        <label class="mt-3">Notas o indicaciones:</label>
        <textarea name="notes" class="form-control" rows="3">{{ form.notes.value|default_if_none:"" }}</textarea>


        <!-- RESUMEN DINÃMICO -->
        <div class="resumen-card">

            <h4 class="mb-3">ðŸ§¾ Resumen del evento</h4>

            <p class="d-flex justify-content-between">
                <span><strong>Total productos:</strong></span>
                <span>${{ total_productos|intcomma }}</span>
            </p>

            <p class="d-flex justify-content-between">
                <span><strong>Precio por hora:</strong></span>
                <span>$20.000</span>
            </p>

            <p class="d-flex justify-content-between">
                <span><strong>Horas seleccionadas:</strong></span>
                <span id="horas"></span>
            </p>

            <hr>

            <p class="d-flex justify-content-between">
                <strong>Total estimado:</strong>
                <span id="total-estimado" style="color:#0d6efd;">$0</span>
            </p>

            <p class="d-flex justify-content-between" style="font-size: 20px; font-weight: bold; color:#198754;">
                Pago inicial (30%):
                <span id="pago-inicial">â€”
                </span>
            </p>

            <button class="reserva-btn mt-3" type="submit">
                ðŸ’³ Pagar 30% y Confirmar Reserva
            </button>

        </div>

    </form>

</div>


<!-- ======================================================
      JAVASCRIPT â€” CÃLCULO DINÃMICO DE HORAS Y TOTAL
====================================================== -->
<script>
    const precioHora = 20000;
    const startInput = document.getElementById("id_start_time");
    const endInput = document.getElementById("id_end_time");

    function calcular() {
        const inicio = startInput.value;
        const fin = endInput.value;

        if (!inicio || !fin) {
            document.getElementById("horas").innerText = "â€”";
            return;
        }

        const h1 = parseInt(inicio.split(":")[0]);
        const h2 = parseInt(fin.split(":")[0]);
        let horas = h2 - h1;

        if (horas < 0) horas = 0;

        document.getElementById("horas").innerText = `${inicio} â€“ ${fin}`;

        const total = horas * precioHora;
        const pago30 = total * 0.30;

        document.getElementById("total-estimado").innerText = "$" + total.toLocaleString();
        document.getElementById("pago-inicial").innerText = "$" + pago30.toLocaleString();
    }

    startInput.addEventListener("change", calcular);
    endInput.addEventListener("change", calcular);
</script>

{% endblock %}
