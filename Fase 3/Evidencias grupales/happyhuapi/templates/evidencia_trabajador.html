{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    body {
        background-color: #121212 !important;
        color: #e0e0e0;
    }

    .card-dark {
        background: #1e1e1e;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
        margin-bottom: 25px;
    }

    .title {
        font-size: 26px;
        font-weight: 700;
        color: #ffffff;
        text-align: center;
        margin-bottom: 15px;
    }

    .btn-dark-action {
        background-color: #0d6efd;
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        transition: 0.2s;
        font-weight: bold;
    }

    .btn-dark-action:hover {
        background-color: #0b5ed7;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .checkbox-item input {
        margin-right: 10px;
    }

    .gallery-img {
        width: 100%;
        max-width: 160px;
        height: 160px;
        object-fit: cover;
        border-radius: 10px;
        margin: 8px;
        border: 2px solid #333;
    }

    #dropzone {
        padding: 35px;
        border: 2px dashed #555;
        border-radius: 12px;
        text-align: center;
        color: #aaa;
        cursor: pointer;
    }

    #dropzone:hover {
        border-color: #0d6efd;
        color: #0d6efd;
    }
</style>

<div class="container">

    <h1 class="title">Evidencia del Evento</h1>

    <!-- INFO EVENTO -->
    <div class="card-dark">
        <h4>{{ booking.customer_name }}</h4>
        <p><strong>Fecha:</strong> {{ booking.event_date }}</p>
        <p><strong>Lugar:</strong> {{ booking.location|default:"—" }}</p>
    </div>

    <!-- HORAS -->
    <div class="card-dark">
        <h4>Registro de Horarios</h4>

        {% if evidencia.arrival_time %}
            <p id="llegadaText" style="color:#4caf50; font-weight:bold;">
                ✔ Llegada registrada: {{ evidencia.arrival_time }}
            </p>
        {% else %}
            <button id="btnLlegada" class="btn-dark-action mb-2">Registrar Llegada</button>
            <p id="llegadaText"></p>
        {% endif %}

        {% if evidencia.finish_time %}
            <p id="salidaText" style="color:#4caf50; font-weight:bold;">
                ✔ Salida registrada: {{ evidencia.finish_time }}
            </p>
        {% else %}
            <button id="btnSalida" class="btn-dark-action mb-2">Registrar Salida</button>
            <p id="salidaText"></p>
        {% endif %}
    </div>

    <!-- CHECKLIST -->
    <div class="card-dark">
        <h4>Checklist</h4>

        <div class="checkbox-item">
            <input type="checkbox" class="check" data-campo="table_installed"
                {% if evidencia.table_installed %}checked{% endif %}>
            <label>Mesa instalada</label>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" class="check" data-campo="decoration_ready"
                {% if evidencia.decoration_ready %}checked{% endif %}>
            <label>Decoración lista</label>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" class="check" data-campo="balloons_ready"
                {% if evidencia.balloons_ready %}checked{% endif %}>
            <label>Globos inflados</label>
        </div>

        <div class="checkbox-item">
            <input type="checkbox" class="check" data-campo="candy_ready"
                {% if evidencia.candy_ready %}checked{% endif %}>
            <label>Candy listo</label>
        </div>
    </div>

    <!-- NOTAS -->
    <div class="card-dark">
        <h4>Notas del trabajador</h4>

        <textarea id="notasInput" class="form-control" rows="4"
                  placeholder="Escribe aquí tus notas...">{{ evidencia.notes }}</textarea>

        <button id="btnGuardarNotas" class="btn-dark-action mt-2">
            Guardar notas
        </button>

        <p id="msgNotas" style="color:#4caf50; display:none; margin-top:10px;">
            ✔ Notas guardadas correctamente
        </p>
    </div>

    <!-- FOTOS -->
    <div class="card-dark">
        <h4>Subir Fotos (se guardan automáticamente)</h4>

        <div id="dropzone">Arrastra fotos aquí o haz clic para seleccionar</div>

        <div class="d-flex flex-wrap mt-3" id="galeria">
            {% for p in photos %}
                <img src="{{ p.image.url }}" class="gallery-img">
            {% endfor %}
        </div>
    </div>

    <!-- FINALIZAR -->
    <div class="card-dark" style="text-align:center; margin-top:20px;">
        <button id="btnFinalizar" class="btn-dark-action"
                style="background:#198754; padding:12px 24px; font-size:18px;">
            ✔ Finalizar evidencia
        </button>
        <p id="msgFinalizado" style="margin-top:15px; color:#198754; font-weight:bold; display:none;">
            Evidencia enviada correctamente. Generando PDF...
        </p>
    </div>

</div>

<!-- ======================================================
     SCRIPT COMPLETO — SIN ERRORES
======================================================== -->
<script>
const bookingId = "{{ booking.id }}";
const csrftoken = "{{ csrf_token }}";

function post(url, data) {
    return fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: data instanceof FormData ? data : new URLSearchParams(data)
    }).then(r => r.json());
}

//
// LLEGADA
//
document.getElementById("btnLlegada")?.addEventListener("click", () => {
    post(`/evidencia/${bookingId}/llegada/`)
    .then(d => {
        if (d.arrival_time) {
            document.getElementById("llegadaText").innerHTML =
                "✔ Llegada registrada: " + d.arrival_time;
        }
    });
});

//
// SALIDA
//
document.getElementById("btnSalida")?.addEventListener("click", () => {
    post(`/evidencia/${bookingId}/salida/`)
    .then(d => {
        if (d.finish_time) {
            document.getElementById("salidaText").innerHTML =
                "✔ Salida registrada: " + d.finish_time;
        }
    });
});

//
//  CHECKLIST
//
document.querySelectorAll(".check").forEach(chk => {
    chk.addEventListener("change", () => {
        post(`/evidencia/${bookingId}/checklist/`, {
            campo: chk.dataset.campo,
            valor: chk.checked
        });
    });
});

//
//  GUARDAR NOTAS
//
document.getElementById("btnGuardarNotas").addEventListener("click", () => {
    const notas = document.getElementById("notasInput").value;

    post(`/evidencia/${bookingId}/notas/`, { notes: notas })
    .then(d => {
        if (d.ok) {
            document.getElementById("msgNotas").style.display = "block";
            setTimeout(() => {
                document.getElementById("msgNotas").style.display = "none";
            }, 1500);
        }
    });
});

//
//  FOTOS
//
const dropzone = document.getElementById("dropzone");
const galeria = document.getElementById("galeria");

dropzone.onclick = () => {
    let input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = e => uploadFiles(e.target.files);
    input.click();
};

dropzone.ondragover = e => e.preventDefault();
dropzone.ondrop = e => {
    e.preventDefault();
    uploadFiles(e.dataTransfer.files);
};

function uploadFiles(files) {
    [...files].forEach(file => {
        let formData = new FormData();
        formData.append("image", file);

        post(`/evidencia/${bookingId}/foto/`, formData)
        .then(d => {
            if (d.photo_url) {
                let img = document.createElement("img");
                img.src = d.photo_url;
                img.className = "gallery-img";
                galeria.appendChild(img);
            }
        });
    });
}

//
//  FINALIZAR
//
document.getElementById("btnFinalizar").addEventListener("click", () => {
    post(`/evidencia/${bookingId}/finalizar/`)
    .then(d => {
        if (d.ok) {
            document.getElementById("msgFinalizado").style.display = "block";
            document.querySelectorAll("button").forEach(b => b.disabled = true);
            document.querySelectorAll("input").forEach(i => i.disabled = true);

            setTimeout(() => {
                window.location.href = d.pdf_url;
            }, 2000);
        }
    });
});
</script>

{% endblock %}
